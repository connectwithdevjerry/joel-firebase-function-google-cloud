/**
 * Import function triggers from their respective submodules:
 *
 * const {onCall} = require("firebase-functions/v2/https");
 * const {onDocumentWritten} = require("firebase-functions/v2/firestore");
 *
 * See a full list of supported triggers at https://firebase.google.com/docs/functions
 */

const { onRequest } = require("firebase-functions/v2/https");
const logger = require("firebase-functions/logger");
const cors = require("cors");
const axios = require("axios");

// console.log("Obaloluwa, it's working!");

// Create and deploy your first functions
// https://firebase.google.com/docs/functions/get-started
//   messages: req.body.messages,
// model: "gpt-4",
// `${callTranscript}`

const messages = (callTranscript) => [
  {
    role: "system",
    content:
      "You are analyzing a sales call transcript with the sole task of determining the accurate output below. The should be exactly a string that can be parsed with the JSON.parse() method",
  },
  {
    role: "user",
    content: `You are analyzing a sales call transcript with the sole task of determining the accurate output below. Here is the call transcript you need to analyze: <call_transcript>${callTranscript}</call_transcript><sales_script>⬜Level 1 - Frame. Did the rep set the frame to determine the game? [Context, Time, Expectations, Spouse] (within 5min)Greeting. Hey NAME, good to connect with you today. Thanks for taking time out of your day to meet with me.My favorite: Noticing something in their background and asking about its story. Otherwise standard small talk (location, etc.) is fine. Context: How did you hear about us? What's your intention for the call today? [High Level Overview] What we're mainly known for is … People/Companies like… come to us to avoid X get Y… Does that sound like what you came here today to learn more about? Time check: Great, and before we get started, do we have the full 45-minutes, or do you have an earlier hard stop we need to respect? Expectations:  Listen, I've had a lot of these calls and so what I've found works best, with your permission, is to first dive deeper into the specifics of really what's going on in your life, your marriage and what the major challenges are truly that are ultimately holding you back from the life you want to be leading. Now the reason we have these calls is to best determine if we can actually help you and part of that is ensuring you're coachable and motivated to actually make changes so that you can realize the life you really want. Once we get some clarity there - IF we can help you, and you are coachable and motivated to change of course, then I'm more than happy to walk you through what an approach for you would look like specifically, is that cool? And on the flip side, if I don't feel like we can actually help you and we're not the best solution, I'll be transparent and let you know and if at all in this conversation you feel like we aren't on the same page either, I want you to let me know as well—sound good? Spouse check: Last thing, to make sure I'm sharing the most relevant information with you, I want to check: If you decide this is a great fit, is there anyone else you'd need to talk with before moving forward, or are you comfortable making the decision yourself today? (If they say 'depends on price') No worries. What's your threshold for making that decision yourself? If they ask about price, just say that we have options and will cover it if you think they're a good fit for the program. Milestone: You know what 'winning' the call looks like (and if you need to set a follow up). 🟥Level 2 - Isolation. Did the rep isolate their biggest frustration (or pain) based on what they are experiencing today? (by the 10min mark). Opening Question: Alright, so walk me through—What's your biggest frustration right now? Abstract >> 'Not getting affection' (If multiple) Out of everything you just said, what's the most frustrating/challenging thing? What about that is most frustrating? / What bothers you the most about that? Other people experience X, but that's not frustrating for them. Why is it frustrating for you? Specific - What happened recently in reality, and what did you want to happen? (thing gap) >> 'Yesterday morning xyz happened' When did that last happen? (how long has this been going on?) What did you want to have happen? Meaning - What does that gap mean? Why is that so bad? (identity gap / ultimate fear) (Vertical Ladder) >> 'I feel like I am a failure' Why exactly is that so frustrating for you? What would be so bad about that? What if that were true? Say your thought is true, why should it bother you? If that were true, what would it mean? What would be the worst thing about that? What would it say about your future? If that thought were true it would bother me because it would mean... Fear (identity) >> 'I will lose everything that's important to me” What does that mean about you? What happens if that continues? Where does this go? What's the worst case? Closing Question: Sounds like X is your biggest frustration because Y, is that right? 🟧Level 3 - Cause. Did the rep find the root cause of the frustration that is within their control? (by the 15min mark) Opening Question: You're very aware of the challenges, why do you feel you haven't been able to solve _______? What's really stopping you? Alternate Deep (cause) and Wide (info) questions 3x Deep questions (cause) What's stopping you from solving this on your own? What's preventing you from being able to _______? What do you feel is actually behind that? (If they don't have an answer) 'Got it. Sounds like what is preventing you is that you lack the clarity of how to solve it solve it. Is that right?' Wide questions (info) Tell me more How long has that been going on for? Closing Question: So X is your biggest frustration, but at the root, the real issue is Y, is that right? >> 'X is their biggest frustration, the root is a huge identity/child wound, and they feel out of control because they don't know how to solve it' 🟨Level 4 - Emotional. Did the rep find a deep emotional pain that is already driving action today? (by the 20min mark) Opening Question: Let's say we backed up a year from today and you solved that root issue... Where would you be today, like, how would today be different if you had to think about it? This being your biggest frustration/challenge/obstacle/bottleneck, how has this impacted you personally? (What ripple effects is it having in your life?) What are the negative implications in your life over the next decade if you don't make a change? What happens if you don't address this issue in the next month, quarter, or year? What's the worst-case scenario if this isn't addressed? Closing Question: So if I understand correctly, if you had solved the root issue last year, instead of X, you would be experiencing Y today, and if you don't solve it soon, then Z will happen. Is that right? 🟩Level 5 - Financial. Did the rep find a financial cost 10x the offer cost that would motivate action? (by the 25min mark) Opening Question: And how much is this costing you financially? Over the last/next year? Choose with your judgment: How is this impacting your ability to generate income? How much will this cost you over the next year? (Only if they don't have a solid answer, use the time approach) Okay, well how much time or mental bandwidth is this costing you per day? How much would you pay to get another hour per day? So it's costing you… [365 x HOURS x DOLLARS x YEARS] $25 $50 $100 $200 1 hour 46k over 5 years 91k over 5 years 183k over 5yrs 73k over 2yrs 365k over 5yrs 146k over 2yrs 73k just this year 2 hours 91k over 5 years 183k over 5yrs 73k over 2yrs 365k over 5yrs 146k over 2yrs 73k just this year 730k over 5yrs 146k just this year Closing Question: So if I understand correctly, by not solving the root issue last year, not only are you experiencing X instead of Y, but it's also costing you Z over T years… is that right? (silence) How do you feel about that? If this is terribly painful, you may proceed. If it's not a big deal to the person, you missed something in discovery. Go back to where you think you missed (e.g. isolation, cause). 'Sounds like this is not a big deal for you… is there something more important to you than ISOLATED FRUSTRATION?' 🟦Level 6 - Bridge. Did the rep build an effective bridge with high engagement resulting in strong belief? Begin with the Prospect's Main Goal or Problem Identify and articulate the key issue or aspiration the prospect has shared. Example: 'You mentioned your goal is to [goal/problem]. This process is designed specifically to help you achieve that.' Introduce the Solution as 3 Pillars (or Steps). Break down the solution into three clear, concise parts, each addressing a specific pain point or goal. Example: 'The first pillar is Framework. This will help you [specific benefit related to their issue, e.g., create consistency in trading].', 'The second pillar is Implementation. This ensures you apply the techniques effectively with guidance.','The third pillar is Accountability. This keeps you on track so you never lose momentum.' Tie Each Pillar to Their Pain Points Use their own words or specific challenges to show how each pillar solves their problems. Include a trial close after each pillar: 'Does this make sense?' or 'Can you see how this will help you?' Summarize and Reinforce Confidence Ask: 'If you had these 3 pillars in place, is there any reason you think you could fail?' Probe further if needed: 'What do you think would stop you from succeeding?' Emphasize their role: 'The only way you could fail is if you didn't follow through, right?' 🟪Level 7 - Obstacles. Did the rep effectively unblock the bridge by pre-handling all non-financial objections? Pre-Handle Objections (Handle Obstacles) Results - If by working with us, the only thing you got was ROOT CAUSE, (how) would that be worth it for you? (used later for an 'if only' objection handle) Probability - Is there any reason you don't think this program would work for you? (pre-handles the snowflake objection) Timing - If our program is a great fit for you, would you be able to start immediately? Effort/Sacrifice (Time) - Are you able and willing to put in at least X hours per week of time? Empowerment - And just to confirm… you're the decision maker and don't need to consult anyone else before making an investment if it makes sense? Pre-Close On my end, and from what I've heard you say, this sounds like a picture-perfect fit for what you want to achieve, but I have to ask, what would stop you from moving forward today? Great, aside from the investment, do you have enough information to make a confident decision about training with us? Closing Question: Assuming finances work, is this something you'd want to move forward with today? — General objection handling.Isolate - If X weren't an issue, would you be moving forward today? Or is there something else holding you back? Reason - Why is that an issue? Solve - How can we make this work? / What would make it work for you? 🟫Level 8 - Logistics. Did the rep present the price and effectively isolate the Value vs Logistics objections using the following questions? Value - Do you think this is worth PRICE? (If NO >> Go to L7) Logistics - Could you get PRICE together? (If YES >> Enroll them) Downpayment - What's the closest to PRICE that you could do today? Duration - How long would it take you to get the PRICE together? Credit Score - And do you know what your credit score is? \n If they are in range >> Offer the exact payment plan that would work based on what they told you \n If they are close >> The lowest we can possibly go for a downpayment is MINIMUM… What would be required to make that happen? \n If they are not close >> Sell the LTO (if available) \n ⬛Level 9 - Objections. Did the rep handle all objections and close the prospect at the full price with the highest downpayment possible today?\n 💠Level 10 - Did the rep run a call so good that all new salespeople should watch it? \n </sales_script> \n ## Output Formatting Rules: \n - All fields shown in the structure are required \n - All string values must be properly escaped if containing quotes \n - No additional fields should be added \n - No comments or trailing commas allowed \n ## Output Format Requirements \n Your analysis must be provided as valid JSON matching exactly this structure WITHOUT the comments: \n { 'frame': { 'is_sales_call': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result, 'result': 1|0 // Must be exactly 1 (Yes it is a sales call) or 0 (No it is not a sales call). If unsure, default to 0 }, 'is_first_call': { \n 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. \n 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result \n 'result': 1|0 // Must be exactly 1 (Yes it is the first call between the salesperson and the prospect) or 0 (No). If unsure, default to 0}, \n 'is_price_after_pitch': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. \n 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result. \n 'result': 1|0 // Must be exactly 1 (Yes the price was not disclosed until after the product was pitched, and it was after the 30min mark) or 0 (No, the price was disclosed before the product was pitched OR it was disclosed before the 30 minute mark). Default to 0 if unsure.}, 'time': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. \n'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result.\n 'asked': 1|0, // Must be exactly 1 (Yes the sales rep explicitly asked if the prospect had a hard stop or time constraint for the call) or 0 (No). If unsure, default to 0 \n'result': 1|0 // Must be exactly 1 (Yes the prospect did have a hard stop or time constraint) or 0 (No). If unsure, default to 1 }, 'auth': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary.\n 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result \n 'asked': 1|0, // Must be exactly 1 (Yes the sales rep explicitly asked if the prospect had the authority to make a decision on their own) or 0 (No). If unsure, default to 0 \n 'result': 1|0 // Must be exactly 1 (Yes the prospect did have the authority to make a decision on their own) or 0 (No, they needed to consult someone else like a spouse). If unsure, default to 0 } }, 'levels': { 'level_1': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result \n 'effective': '', // Must be your notes on what the rep did well in this level \n 'improvement': '', // Must be your notes on what the rep could have done better in this level. \n 'result': 0-10 // Must be exactly an integer in the range of 0 (low) to 10 (high) indicating the sales rep's skill at executing this level, as measured by the main question for each level (e.g. Did the rep find a deep emotional pain that is already driving action today?). If they get the result but in an unorthodox way, that is acceptable - I only care about the result and not the method; however a 10 is reserved for following the method.}, 'level_2': { 'evidence': '', 'reasoning': '', 'effective': '', 'improvement': '', 'result': 0-10 }, ... ## Notes on each level. \n 1. The rep should have a greeting, context gathering, time check, expectations setting, and spouse check (assuming it's the first call; if not, a minimal frame is fine) \n 2. The rep should isolate their biggest frustration (or pain) based on what they are experiencing today \n 3. The rep should find the root cause of the frustration that is within their control \n 4. The rep should find a deep emotional pain that is already driving action today \n 5. The rep should find a financial cost 10x the offer cost that would motivate action \n 6. The rep should build an effective bridge with high engagement (tying each pillar to solving their problem), resulting in strong belief that the product will solve the prospect's deep emotional pain. \n 7. The rep should effectively unblock the bridge by pre-handling all non-financial objections (results, probability, timing, effort/sacrifice, decision making) as demonstrated with a pre close \n 8. The rep should follow the process in Level 8 exactly in order to effectively identify if there is a value or logistics objection (or neither) \n 9. The rep should handle all objections that come up so that the prospect attempts to make a purchase with the highest downpayment possible today based on the prospect's logistics (standard pricing is fine). If the prospect attempts to make a purchase at the full standard pricing, this is automatically a \n 10. This is either a 1 or 0. It is only a 1 if all of the above are at least an 8 and the sale is made. Otherwise it is a 0. }, 'problem_value': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. \n 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result \n 'asked': 1|0, // Must be exactly 1 (Yes the sales rep was able to get a dollar value to represent the prospect's problem) or 0 (No). If unsure, default to 0 \n'result': 0|'' // Must be the integer of the dollar value that solving the prospect's problem is worth to them. If unsure, default to 0 }, \n 'objections': { \n 'objection_fit': { 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. \n 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result \n 'present': 0|1, // Must be exactly 1 (Yes this objection was present) or 0 (No). If unsure, default to 1 \n 'handled': 0|1 // Must be exactly 1 (Yes the sales rep handled the objection so that it was not a blocker to buying today) or 0 (No). If unsure, default to 0 }, 'objection_timing': { 'evidence': '', 'reasoning': '', 'present': 0|1, 'handled': 0|1 }, ... /* ## Notes on each objection objection_fit - This is the 'I am not sure it will work for me' special snowflake objection. It rarely uses these exact words, but it's easy to spot when the prospect doesn't think it will actually work, or estimates the probability to be low. objection_timing - This is the 'I will do it when or after X event/situation' (at least a week, and typically months later) objection. IMPORTANT: The following are not timing objections [delaying of making the decision (that's avoidance), I need to sleep on it, I need to think about it, let's follow up on Monday] objection_time - This is the 'I do not have enough time IN THE DAY' objection, specifically referring to their inability to fit it into a day. IMPORTANT: The following are not time objections [I can't do it until next month, I need to sleep on it, I need to think on it, let's follow up on Monday] objection_authority - This is the 'I need to talk with my spouse/boss/etc. about it' objection, in which the person abdicates decision making ability to someone else so that they don't need to make a decision on the spot. objection_avoidance - This is the 'I have to think about it' / 'I need more time' / 'I do not make decisions on the phone' objection, which is the prospect's way of avoiding having to make a mistake. IMPORTANT: The following are not avoidance objections [I need to talk with my spouse, I'm going to talk it over with my wife and then get back to you] */ }, 'logistics': { 'value': { // Do you think this is worth PRICE? 'evidence': '', // Must include the most definitive direct quote(s) verbatim from the transcript. Include context where necessary. 'reasoning': '', // Must be your thought process of evaluating that evidence to determine the result 'asked': 0|1, // Must be exactly 1 (Yes the salesperson asked this question) or 0 (No). If unsure, default to 0 \n 'result': 0|1 // Must be exactly 1 (Yes the prospect thinks the cost is reasonable, even if they don't have the finances for it) or 0 (No). If unsure, default to 0 }, 'logistics': { // Could you get PRICE together? 'evidence': '', 'reasoning': '', 'asked': 0|1, 'result': 0|1 }, 'downpayment': { // What's the closest to PRICE that you could do today? 'evidence': '', 'reasoning': '', 'asked': 0|1, 'result': 0|'' // Must be the integer dollar amount the prospect says they have available today in response to the question. If the salesperson doesn't ask or if unsure, default to 0. }, 'duration': { // How long would it take you to get the PRICE together? \n 'evidence': '', 'reasoning': '', 'asked': 0|1, 'result': 0|'' // Must be the integer number of months required for the prospect to get the remaining funds for the product. If the salesperson doesn't ask or if unsure, default to 0. }, 'credit': { // Credit Score - And do you know what your credit score is? 'evidence': '', 'reasoning': '', 'asked': 0|1, 'result': 0|'' // Must be the integer number of the prospect's credit score. If they say something like 'excellent' or a range, use the low end of the range. If the salesperson doesn't ask or if the prospect does not know, default to 0. } }, 'outcome': { 'won': { 'evidence': '', 'reasoning': '', 'result': 0|1, // Must be exactly 1 (Yes the call was won with a purchase) or 0 (No). If unsure, default to 0 }, 'follow_up_scheduled': { 'evidence': '', 'reasoning': '', 'result': 0|1, // Must be exactly 1 (Yes there is a follow up meeting scheduled with a specific date and time) or 0 (No). If unsure, default to 0 }, 'follow_up': { 'evidence': '', 'reasoning': '', 'result': 0|1, // Must be exactly 1 (Yes there is follow up intention) or 0 (No). If unsure, default to 0 }, 'call_dropped': { 'evidence': '', 'reasoning': '', 'result': 0|1 // Must be exactly 1 (Yes the call dropped suddenly and the salesperson was left hanging) or 0 (No). If unsure, default to 0 }, 'lost': { 'evidence': '', 'reasoning': '', 'result': 0|1, // Must be exactly 1 (Yes the call was lost with no follow up intention) or 0 (No). If unsure, default to 1 } } }`,
  },
];

const Authorization = `Bearer ${process.env.OPEN_AI_KEY}`;

exports.processOpenAI = onRequest(async (req, res) => {
  res.set("Access-Control-Allow-Origin", "*"); // Allow all origins
  res.set("Access-Control-Allow-Methods", "GET, POST"); // Allow methods
  res.set("Access-Control-Allow-Headers", "Content-Type");

  try {
    const openAiResponse = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "chatgpt-4o-latest",
        messages: messages(req.body.transcript),
      },
      {
        headers: {
          Authorization,
          "Content-Type": "application/json",
        },
      }
    );

    const result = openAiResponse.data?.choices[0]?.message?.content
      ?.replace(/\s+/g, " ")
      .replace("json ", "")
      .replace('"""', "")
      .replace("```", "")
      .replace(" ```", "")
      ?.trim()
      .toString();

    res.status(200).json(result);
  } catch (error) {
    console.error(error.message);
    console.error(error);
    res.status(500).json({
      error: error.response
        ? error.response.data
        : "Failed to fetch OpenAI response",
    });
  }
});
